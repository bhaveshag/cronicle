<!DOCTYPE html>
<html>
<head>
<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.96.1/css/materialize.min.css"
	media="screen,projection"/>	
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<title>Cronicle</title>
</head>

<body>

<div class="container">
<p>
<a class="btn-floating btn-large waves-effect waves-light red right" id="add-cron"><i class="mdi-content-add large"></i></a>
</p>


<div id="cronlist" class="row">
<h2 class="red-text">
No cron's configured yet 
</h2>

</div> 


<div id="main-modal" class="modal">
    <div class="modal-content">
    </div>
    <div class="modal-footer">
      <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">CLOSE</a>
    </div>
</div>
  
<script type="text/template" id="tpl-runlist">
<table class="bordered striped col s12">
<thead>
<tr>
	<th>Scheduled</th>
	<th>Start</th>
	<th>End</th>
	<th>Status</th>
</tr>
</thead>
<tbody>
{{#each runs}}
<tr>
	<td>{{dateFormat scheduleTime}}</td>
	<td>{{dateFormat startTime}}</td>
	<td>{{dateFormat endTime}}</td>
	<td>{{status}}</td>
</tr>
{{/each}}
</tbody>
</table>

</script>

<script type="text/template" id="tpl-cronlist">
<table class="bordered striped col s12">
<thead>
<tr>
	<th>Cron</th>
	<th>Last Run Status</th>
	<th>Next Run At</th>
</tr>
</thead>
<tbody>
{{#each crons}}
<tr>
	<td>
<a href="#" onClick="showEditCron('{{key}}');return false;" class="waves-effect waves-teal btn-flat left">
<i class="tiny mdi-editor-mode-edit"></i></a>
         <strong>{{name}}</strong> - {{description}}<br/><small>{{key}}</small>
    </td>
	<td>
<strong class="left">{{lastRunStatus}}</strong> 
<a href="#" onClick="showRunLog('{{key}}');return false;" class="btn btn-floating right"><i class="tiny mdi-action-list"></i></a>
	</td>
	<td>{{dateFormat nextRun}}<br/><small>{{expression}}<small></td>
</tr>
{{/each}}
</tbody>
</table>
</script>

<script type="text/template" id="tpl-cronform">
<div class="row">
<form name="cronform" id="cronform" class="col s12">
	<div class="row">
		<div class="input-field col s12">
          <input  id="name" type="text" name="name" class="validate" required="required"
            placeholder="this is a quick name/code identifier; better to keep it without spaces"
			value="{{name}}">
          <label for="name" class="active">Name</label>
        </div>
	</div>
	<div class="row">
		<div class="input-field col s12">
          <input  id="description" type="text" name="description" class="validate" required="required"
            value="{{description}}">
          <label for="description" class="active">Description</label>
        </div>
	</div>
	<div class="row">
		<div class="input-field col s8">
          <input  id="expression" type="text" name="expression" class="validate" required="required"
          placeholder="quartz compliant; if using regular unix, prepend with a 0"
          value="{{expression}}">
          <label for="expression" class="active">Cron Expression</label>
        </div>
		<div class="input-field col s4">
          <input  id="timezone" type="text" name="timezone" value="{{timezone}}">
          <label for="timezone" class="active">Timezone</label>
        </div>
	</div>

	<div class="row">
		<div class="input-field col s6">
          <input  id="gracePeriodForStart" type="number" name="gracePeriodForStart" class="validate" required="required" value="{{gracePeriodForStart}}">
          <label for="gracePeriodForStart" class="active">Grace Period For Start (m)</label>
        </div>
		<div class="input-field col s6">
          <input  id="maxRuntime" type="number" name="maxRuntime" class="validate" required="required" value="{{maxRuntime}}">
          <label for="maxRuntime" class="active">Timeout(m)</label>
        </div>
	</div>
	<div class="row">
		<div class="col s6">
		  <button class="btn col s12 waves-effect waves-light" type="submit" name="action">Save
		  </button>
        </div>
		<div class="col s6">
		  <button type="reset" class="btn col s12 red waves-effect waves-light" name="reset">Reset
		  </button>
        </div>
	</div>
{{#if key}}
<input type="hidden" name="key" value="{{key}}"/>
{{/if}}
</form>
</div>
</div>
</script>


<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment-with-locales.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.96.1/js/materialize.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>

<script type="text/javascript">
moment.locale('en');
//format an ISO date using Moment.js
//http://momentjs.com/
//moment syntax example: moment(Date("2011-07-18T15:50:52")).format("MMMM YYYY")
//usage: {{dateFormat creation_date format="MMMM YYYY"}}
Handlebars.registerHelper('dateFormat', function(context, block) {
	if (window.moment) {
		var f = block.hash.format || "ddd, MMM DD, YYYY hh:mm:ss A";
		if (context == null) return "";
		return moment(context).format(f); //had to remove Date(context)
	} else {
		return context; //  moment plugin not available. return data as is.
	}
	;
});
Handlebars.registerHelper('timeFromNow', function(context) {
	if (window.moment) {
		if (content == null) return "";
		return moment(context).fromNow(); 
	} else {
		return context; //  moment plugin not available. return data as is.
	}
	;
});

function loadCronList() {
	$.ajax({
		url : "./crons/"
	}).done(function(data) {
		var tpl = Handlebars.compile($("#tpl-cronlist").html());
		var ctx = {
			"crons" : []
		};
		if (data._embedded && data._embedded.cron) {
			ctx.crons = data._embedded.cron;
		}
		;
		$("#cronlist").html(tpl(ctx));
	});
}
$(document).ready(function() {
	loadCronList();
});

$(document).on("submit", "#cronform", function(e){
	e.preventDefault();
	var dump = $("#cronform").serializeArray(),
	    len = dump.length;
	var dumpdata = {}; 
	for (i=0; i<len; i++) {
	  key = dump[i].name;
      var v = dump[i].value;
      dumpdata[key] = v;
	}
	dumpdata.gracePeriodForStart = parseInt(dumpdata.gracePeriodForStart);
	dumpdata.maxRuntime = parseInt(dumpdata.maxRuntime);
	console.log(dumpdata);
	if ('key' in dumpdata) {
		//edit
		$.ajax({
			url: "./crons/"+dumpdata.key,
			type: "PATCH",
			data: JSON.stringify(dumpdata),
			contentType: "application/json",
			dataType: "json",
			success: function(){
				closeMainModal();
				loadCronList();
				//TODO: handle failure
			}
		});
	} else {
		$.ajax({
			url: "./crons/",
			type: "POST",
			data: JSON.stringify(dumpdata),
			contentType: "application/json",
			dataType: "json",
			success: function(){
				closeMainModal();
				loadCronList();
				//TODO: handle failure
			}
		});
	}
});

function showRunLog(job) {
	$.ajax({
		url : "./job/" + job
	}).done(function(data) {
		console.log(data);
		var tpl = Handlebars.compile($("#tpl-runlist").html());
		var ctx = {
			"runs" : data
		};
		$(".modal-content").html(tpl(ctx));
		openMainModal();
	});
}

function showAddCron() {
	var tpl = Handlebars.compile($("#tpl-cronform").html());
	var ctx = {"gracePeriodForStart":5, "maxRuntime":-1};
	$(".modal-content").html(tpl(ctx));
	openMainModal();
	$("#name").focus();
}

function showEditCron(guid) {
	var tpl = Handlebars.compile($("#tpl-cronform").html());
	$.ajax({
		url: "./crons/" + guid,
		method: "GET",
		contentType: "application/json",
		success: function(ctx) {
			$(".modal-content").html(tpl(ctx));
			openMainModal();
			$("#name").focus();
		  }
		});
}


function openMainModal(){
	$('#main-modal').openModal();
}

function closeMainModal(){
	$('#main-modal').closeModal();
}


$('#add-cron').click(showAddCron);

</script>

</body>
</html>